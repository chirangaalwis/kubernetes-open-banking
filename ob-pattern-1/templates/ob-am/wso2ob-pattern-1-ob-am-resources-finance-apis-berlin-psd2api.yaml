# Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "ob-pattern-1.resource.prefix" . }}-ob-am-resources-finance-apis-berlin-psd2api
  namespace : {{ .Values.namespace }}
data:
  dynamic-endpoint-insequence-1.3.3.xml: |-
    <!--
      ~ Copyright (c) 2019, WSO2 Inc. (http://www.wso2.com). All Rights Reserved.
      ~
      ~ This software is the property of WSO2 Inc. and its suppliers, if any.
      ~ Dissemination of any information or reproduction of any material contained
      ~ herein is strictly forbidden, unless permitted by WSO2 in accordance with
      ~ the WSO2 Commercial License available at http://wso2.com/licenses. For specific
      ~ language governing the permissions and limitations under this license,
      ~ please see the license as well as any agreement youâ€™ve entered into with
      ~ WSO2 governing the purchase of this software and any associated services.
      ~
      -->

    <sequence xmlns="http://ws.apache.org/ns/synapse" name="dynamic-endpoint-insequence-1.3.3.xml">
        <property name="endpointURI" expression="get-property('To')"/>

        <switch source="$ctx:endpointURI">
            <case regex=".*payments.*">
                <header name="TPP-Unique-ID" scope="transport" expression="get-property('api.ut.consumerKey')"/>
                <filter source="$ctx:endpointURI" regex=".*authorisations.*">
                    <then>
                        <filter source="$ctx:endpointURI" regex=".*cancellation.*">
                            <then>
                                <payloadFactory media-type="json">
                                    <format>{}</format>
                                </payloadFactory>
                                <header name="To" value="https://{{ template "ob-pattern-1.resource.prefix" . }}-ob-km-service:9446/consent/berlin130/authorisation"/>
                            </then>
                            <else>
                                <header name="To" value="https://{{ template "ob-pattern-1.resource.prefix" . }}-ob-km-service:9446/consent/berlin130/authorisation"/>
                            </else>
                        </filter>
                    </then>
                    <else>
                        <filter source="get-property('api.ut.HTTP_METHOD')" regex="POST">
                            <then>
                                <header name="To" value="https://{{ template "ob-pattern-1.resource.prefix" . }}-ob-km-service:9446/consent/berlin130/payments"/>

                                        <payloadFactory media-type="json">
                                            <format>[$1]</format>
                                            <args>
                                                <arg evaluator="json" expression="$"/>
                                            </args>
                                        </payloadFactory>
                            </then>
                            <else>
                                <property name="resourcePath" scope="default" type="STRING" value=""/>
                                <property expression="get-property('resourcePath')" name="REST_URL_POSTFIX" scope="axis2"
                                          type="STRING"/>

                                <header name="To"
                                        expression="fn:concat('https://{{ template "ob-pattern-1.resource.prefix" . }}-ob-km-service:9446/consent/berlin130/payments', get-property('api.ut.resource'))"/>
                            </else>
                        </filter>
                    </else>
                </filter>
            </case>
            <case regex=".*/accounts.*">
                <filter source="$ctx:AM_KEY_TYPE" regex="PRODUCTION">
                    <then>
                        <header name="To" value="https://localhost:9443/open-banking-berlin/services/accounts"/>
                    </then>
                    <else>
                        <header name="To" value="https://localhost:9443/open-banking-berlin/services/accounts"/>
                    </else>
                </filter>
            </case>
            <case regex=".*/card-accounts.*">
                <filter source="$ctx:AM_KEY_TYPE" regex="PRODUCTION">
                    <then>
                        <header name="To" value="https://localhost:9443/open-banking-berlin/services/accounts"/>
                    </then>
                    <else>
                        <header name="To" value="https://localhost:9443/open-banking-berlin/services/accounts"/>
                    </else>
                </filter>
            </case>
            <case regex=".*/consents.*">
                <filter source="$ctx:endpointURI" regex=".*authorisations.*">
                    <then>
                        <header name="TPP-Unique-ID" scope="transport" expression="get-property('api.ut.consumerKey')"/>
                        <header name="To" value="https://{{ template "ob-pattern-1.resource.prefix" . }}-ob-km-service:9446/consent/berlin130/authorisation/consent"/>
                    </then>
                    <else>
                        <property action="remove" name="REST_URL_POSTFIX" scope="axis2"/>
                        <header name="To" expression="fn:concat('https://{{ template "ob-pattern-1.resource.prefix" . }}-ob-km-service:9446/consent/berlin130' , get-property('api.ut.resource'))"/>
                        <header name="TPP-Unique-ID" expression="get-property('api.ut.consumerKey')" scope="transport"/>
                        <header name="App-ID" expression="get-property('api.ut.application.id')" scope="transport"/>
                        <rewrite>
                            <rewriterule>
                                <action type="replace" regex="\/consents" value="\/accounts" fragment="path"/>
                            </rewriterule>
                        </rewrite>
                    </else>
                </filter>
            </case>
            <case regex=".*/funds-confirmations.*">
                <filter source="$ctx:AM_KEY_TYPE" regex="PRODUCTION">
                    <then>
                        <header name="To" value="https://localhost:9443/open-banking-berlin/services/cof"/>
                    </then>
                    <else>
                        <header name="To" value="https://localhost:9443/open-banking-berlin/services/cof"/>
                    </else>
                </filter>
            </case>
            <case regex=".*/signing-baskets.*">
                <!--todo: error saying 404 not found-->
            </case>
            <default>
                <!--todo: error saying 404 not found-->
            </default>
        </switch>
        <!--Appending Basic Auth for Consent Management APIs-->
        <header name="Authorization" scope="transport" action="remove" />
        <class name="com.wso2.finance.open.banking.gateway.api.synapse.mediator.BasicAuthMediator"/>
        <header name="Authorization" expression="$ctx:basicAuthentication" scope="transport"/>
        <!--End-->
        <property name="ENDPOINT_ADDRESS" expression="get-property('To')"/>
    </sequence>
